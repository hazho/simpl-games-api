# set ft=python

from django.utils import six
from thorn import validators as thorn_validators
from jslog4kube import LOGGING

LOGGING['loggers']['rest_framework'] = LOGGING['loggers']['demo']
LOGGING['loggers']['allauth'] = LOGGING['loggers']['demo']
LOGGING['loggers']['cuser'] = LOGGING['loggers']['demo']
LOGGING['loggers']['thorn.django'] = LOGGING['loggers']['demo']
LOGGING['loggers']['simpl_users'] = LOGGING['loggers']['demo']
LOGGING['loggers']['courses'] = LOGGING['loggers']['demo']
LOGGING['loggers']['simpl'] = LOGGING['loggers']['demo']
LOGGING['loggers']['kombu'] = LOGGING['loggers']['demo']

from config.settings.common import *  # noqa
from config.settings.env import e as E

SECRET_KEY = env("DJANGO_SECRET_KEY")
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

# django-secure
# ------------------------------------------------------------------------------
INSTALLED_APPS += ("djangosecure", )

SECURITY_MIDDLEWARE = (
    'djangosecure.middleware.SecurityMiddleware',
)


# Make sure djangosecure.middleware.SecurityMiddleware is listed first
MIDDLEWARE_CLASSES = SECURITY_MIDDLEWARE + MIDDLEWARE_CLASSES

# SITE CONFIGURATION
# ------------------------------------------------------------------------------
# Hosts/domain names that are valid for this site
# See https://docs.djangoproject.com/en/1.6/ref/settings/#allowed-hosts
ALLOWED_HOSTS = ['simpl.dev.wharton.revsys.com', 'simpl-api.simpl']
# END SITE CONFIGURATION

INSTALLED_APPS += ("gunicorn", )

TEMPLATES[0]['OPTIONS']['loaders'] = [
    ('django.template.loaders.cached.Loader', [
        'django.template.loaders.filesystem.Loader', 'django.template.loaders.app_directories.Loader', ]),
]

# DATABASE CONFIGURATION
# ------------------------------------------------------------------------------
# Raises ImproperlyConfigured exception if DATABASE_URL not in os.environ
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'HOST': E.db_host,
        'NAME': E.db_name,
        'PASSWORD': E.db_pass,
        'PORT': int(E.db_port) if E.count('db_port') else 5432,
        'USER': E.db_user,
        'CONN_MAX_AGE': 60,
    }
}

SESSION_ENGINE = "django.contrib.sessions.backend.cached_db"
INSTALLED_APPS += ('django.contrib.sessions')


# Set CONN_MAX_AGE
# DATABASES['default']['CONN_MAX_AGE'] = 500

# CACHING
# ------------------------------------------------------------------------------
# Heroku URL does not pass the DB number, so we parse it in
CACHES = {
  'default': {
      'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',
      'LOCATION': "memcache:11211",
  },
}

# Your production stuff: Below this line define 3rd party library settings
THORN_RECIPIENT_VALIDATORS = [
    thorn_validators.block_internal_ips(),
    thorn_validators.ensure_protocol('http', 'https'),
    thorn_validators.ensure_port(80, 443, 8080),
]
